<div class="container mx-auto px-4 py-8 space-y-8">
  <!-- Header -->
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pb-4"
  >
    <div>
      <h1
        class="text-3xl font-semibold tracking-tight bg-gradient-to-r from-indigo-400 via-sky-400 to-emerald-400 bg-clip-text text-transparent"
      >
        Reviews & Insights
      </h1>
      <p class="text-sm text-surface-500 dark:text-surface-300 mt-1">
        Capture learnings, rate experiences, share value.
      </p>
    </div>
    <div class="flex gap-2">
      <button
        pButton
        label="Add Review"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="showReviewForm = true"
      ></button>
    </div>
  </div>

  <!-- Stats Bar -->
  <div
    class="flex flex-wrap items-center justify-center gap-12 py-8 my-10 rounded-2xl"
  >
    <div class="flex flex-col items-center gap-3 min-w-[120px]">
      <div class="flex items-center gap-4">
        <i class="pi pi-comments text-3xl text-blue-500"></i>
        <p-badge
          [value]="reviews.length"
          severity="info"
          styleClass="text-xl px-3 py-2"
        ></p-badge>
      </div>
      <p class="text-sm font-medium text-surface-700 dark:text-surface-300">
        Total Reviews
      </p>
    </div>

    <div class="flex flex-col items-center gap-3 min-w-[140px]">
      <div class="flex items-center gap-4">
        <i class="pi pi-star text-3xl text-amber-500"></i>
        <div class="flex items-center gap-3">
          <p-badge
            [value]="averageRating"
            severity="warn"
            styleClass="text-xl px-3 py-2"
          ></p-badge>
          <p-rating
            [readonly]="true"
            [ngModel]="Math.round(averageRating)"
            class="scale-90"
          ></p-rating>
        </div>
      </div>
      <p class="text-sm font-medium text-surface-700 dark:text-surface-300">
        Average Rating
      </p>
    </div>

    <div class="flex flex-col items-center gap-3 min-w-[130px]">
      <div class="flex items-center gap-4">
        <i class="pi pi-thumbs-up text-3xl text-emerald-500"></i>
        <p-badge
          [value]="recommendRate + '%'"
          severity="success"
          styleClass="text-xl px-3 py-2"
        ></p-badge>
      </div>
      <p class="text-sm font-medium text-surface-700 dark:text-surface-300">
        Recommend Rate
      </p>
    </div>
  </div>

  <!-- Filters -->
  <div class="rounded-xl flex flex-col md:flex-row gap-4 md:items-center">
    <!-- <div class="flex flex-col sm:flex-row gap-3 flex-1"> -->
    <span class="p-input-icon-left w-full sm:w-72">
      <input
        pInputText
        type="text"
        class="w-full"
        placeholder="Search (book, author, takeaway)"
        [(ngModel)]="filterText"
        (input)="applyFilters()"
        name="filterText"
      />
    </span>
    <p-select
      [options]="ratingOptions"
      [(ngModel)]="filterRating"
      placeholder="Rating"
      (onChange)="applyFilters()"
      [showClear]="true"
      name="filterRating"
      styleClass="w-full sm:w-44"
    ></p-select>
    <p-select
      [options]="recommendOptions"
      [(ngModel)]="filterRecommend"
      placeholder="Recommend"
      (onChange)="applyFilters()"
      [showClear]="true"
      name="filterRecommend"
      styleClass="w-full sm:w-48"
    ></p-select>
    <!-- </div> -->

    <button
      pButton
      label="Clear"
      icon="pi pi-filter-slash"
      class="p-button-outlined"
      type="button"
      (click)="clearFilters()"
    ></button>
  </div>

  <!-- Reviews Grid -->
  <div
    *ngIf="filteredReviews.length; else emptyState"
    class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"
  >
    <p-card
      *ngFor="let review of filteredReviews; trackBy: trackByReviewId"
      styleClass="h-full"
    >
      <ng-template pTemplate="header">
        <div class="px-6 pt-6 pb-2">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1 min-w-0">
              <h3
                class="text-lg font-semibold truncate text-surface-900 dark:text-surface-100"
              >
                {{ review.book }}
              </h3>
              <p
                class="text-sm text-surface-600 dark:text-surface-400 truncate"
              >
                by {{ review.author }}
              </p>
            </div>
            <p-tag
              [severity]="review.wouldRecommend ? 'success' : 'danger'"
              [value]="review.wouldRecommend ? '👍' : '👎'"
              styleClass="text-xs ml-2 flex-shrink-0"
            >
            </p-tag>
          </div>
          <div class="flex items-center gap-2">
            <p-rating
              [ngModel]="review.rating"
              [readonly]="true"
              class="scale-75 origin-left"
            ></p-rating>
            <span class="text-xs font-medium text-amber-600 dark:text-amber-400"
              >{{ review.rating }}/5</span
            >
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="content">
        <div class="space-y-3">
          <div>
            <p
              class="text-sm leading-relaxed text-surface-700 dark:text-surface-300 line-clamp-4"
            >
              {{ review.takeaways }}
            </p>
          </div>
        </div>
      </ng-template>
      <ng-template pTemplate="footer">
        <div class="flex items-center justify-between mb-3">
          <span class="text-xs text-surface-500 dark:text-surface-400">
            {{ review.date | date : "mediumDate" }}
          </span>
          <p-tag
            [severity]="review.wouldRecommend ? 'success' : 'danger'"
            [value]="review.wouldRecommend ? 'Recommended' : 'Not Recommended'"
            styleClass="text-xs"
          >
          </p-tag>
        </div>
        <div class="flex gap-2">
          <button
            pButton
            label="Details"
            icon="pi pi-eye"
            class="p-button-outlined p-button-sm flex-1"
            (click)="viewReviewDetails(review)"
          ></button>
          <button
            pButton
            label="Edit"
            icon="pi pi-pencil"
            class="p-button-sm flex-1"
            (click)="editReview(review)"
          ></button>
        </div>
      </ng-template>
    </p-card>
  </div>

  <ng-template #emptyState>
    <div
      class="flex flex-col items-center gap-4 py-16 rounded-xl border border-dashed border-surface-300 dark:border-surface-600 bg-white/40 dark:bg-surface-800/40"
    >
      <i class="pi pi-inbox text-4xl text-surface-400"></i>
      <p class="text-sm text-surface-500 dark:text-surface-400">
        No reviews yet. Start by adding your first one.
      </p>
      <button
        pButton
        label="Add Review"
        icon="pi pi-plus"
        class="p-button-sm"
        (click)="showReviewForm = true"
      ></button>
    </div>
  </ng-template>

  <!-- Create / Edit Dialog -->
  <p-dialog
    [(visible)]="showReviewForm"
    header="Add Review"
    [modal]="true"
    [draggable]="false"
    [style]="{ width: '40rem' }"
    [breakpoints]="{ '960px': '90vw', '640px': '95vw' }"
    (onHide)="clearNewReview()"
  >
    <form (ngSubmit)="submitReview()" class="space-y-6">
      <div class="grid gap-4 md:grid-cols-2">
        <div class="flex flex-col gap-2">
          <label for="book" class="text-sm font-medium">Book</label>
          <input
            pInputText
            id="book"
            name="book"
            type="text"
            [(ngModel)]="newReview.book"
            required
            placeholder="Deep Work"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="author" class="text-sm font-medium">Author</label>
          <input
            pInputText
            id="author"
            name="author"
            type="text"
            [(ngModel)]="newReview.author"
            required
            placeholder="Cal Newport"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium">Rating</label>
          <div class="flex items-center gap-3">
            <p-rating [(ngModel)]="newReview.rating" name="rating"></p-rating>
            <span
              class="text-xs font-semibold text-amber-600 dark:text-amber-400"
              >{{ newReview.rating || 0 }}/5</span
            >
          </div>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium">Recommend?</label>
          <div class="flex gap-2">
            <button
              type="button"
              pButton
              icon="pi pi-thumbs-up"
              [severity]="
                newReview.wouldRecommend === true ? 'success' : 'secondary'
              "
              (click)="newReview.wouldRecommend = true"
              class="p-button-sm"
            ></button>
            <button
              type="button"
              pButton
              icon="pi pi-thumbs-down"
              [severity]="
                newReview.wouldRecommend === false ? 'danger' : 'secondary'
              "
              (click)="newReview.wouldRecommend = false"
              class="p-button-sm"
            ></button>
          </div>
        </div>
        <div class="md:col-span-2 flex flex-col gap-2">
          <label for="takeaways" class="text-sm font-medium"
            >Key Takeaways / Insights</label
          >
          <textarea
            pInputText
            id="takeaways"
            name="takeaways"
            rows="5"
            [(ngModel)]="newReview.takeaways"
            required
            placeholder="What resonated? Action items or quotes?"
            class="resize-y"
          ></textarea>
        </div>
      </div>
      <div
        class="flex items-center justify-end gap-2 pt-2 border-t border-surface-200 dark:border-surface-700"
      >
        <button
          pButton
          type="button"
          label="Reset"
          class="p-button-outlined p-button-sm"
          (click)="clearNewReview()"
        ></button>
        <button
          pButton
          type="button"
          label="Cancel"
          class="p-button-text p-button-sm"
          (click)="showReviewForm = false"
        ></button>
        <button
          pButton
          type="submit"
          label="Save"
          class="p-button-sm"
          [disabled]="
            !newReview.rating ||
            !newReview.book ||
            !newReview.author ||
            !newReview.takeaways ||
            newReview.wouldRecommend === null
          "
        ></button>
      </div>
    </form>
  </p-dialog>
</div>
