<div class="space-y-2">
  <!-- Multi Selection Mode (Always) -->
  <p-multiSelect
    #multiSelectRef
    [options]="genreOptions"
    [ngModel]="value"
    [placeholder]="placeholder"
    class="w-full"
    [showHeader]="true"
    (onChange)="onSelectionChange($event)"
  >
    <ng-template pTemplate="header">
      <div class="flex items-center justify-between px-3 py-2 border-b">
        <span class="font-medium">Select Genres</span>
        <button
          type="button"
          class="text-blue-600 hover:text-blue-800 text-sm font-medium"
          (click)="showAddGenreForm()"
          *ngIf="!showAddForm"
        >
          + Add New
        </button>
      </div>
    </ng-template>
  </p-multiSelect>

  <!-- Selected Genres Display -->
  <div
    *ngIf="selectedGenres && selectedGenres.length > 0"
    class="flex flex-wrap gap-2 mt-2"
  >
    <span
      *ngFor="let item of selectedGenres; trackBy: trackByGenreName"
      class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200"
    >
      <!-- Genre icon based on preference -->
      <i
        *ngIf="showPreferences && item.genre && item.icon"
        [class]="item.icon"
        class="mr-1"
      ></i>
      {{ item.name }}

      <!-- Preference button -->
      <button
        *ngIf="showPreferences"
        type="button"
        class="ml-1 text-blue-600 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-100"
        (click)="openPreferenceDialog(item.id)"
        title="Set preference"
      >
        <i class="pi pi-cog text-xs"></i>
      </button>

      <!-- Remove button -->
      <button
        type="button"
        class="ml-1 text-blue-600 hover:text-blue-800 dark:text-blue-300 dark:hover:text-blue-100"
        (click)="removeGenre(item.id)"
      >
        Ã—
      </button>
    </span>
  </div>

  <!-- Add New Genre Form -->
  <div
    *ngIf="showAddForm"
    class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 rounded-lg p-4 border-2 border-blue-200 dark:border-gray-600 mt-3"
  >
    <div class="space-y-4">
      <div class="flex items-center gap-2">
        <i class="pi pi-plus-circle text-blue-600"></i>
        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">
          Create New Genre
        </h4>
      </div>
      <div class="grid grid-cols-1 gap-4">
        <!-- Genre Name -->
        <div class="space-y-2">
          <label
            class="block text-sm font-semibold text-gray-700 dark:text-gray-200"
          >
            <i class="pi pi-tag text-blue-500 mr-1"></i>
            Genre Name *
          </label>
          <input
            type="text"
            [(ngModel)]="newGenreName"
            [ngModelOptions]="{ standalone: true }"
            placeholder="e.g., Epic Fantasy, Space Opera"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 font-medium"
            (keyup.enter)="createNewGenre()"
            maxlength="50"
          />
        </div>

        <!-- Description -->
        <div class="space-y-2">
          <label
            class="block text-sm font-semibold text-gray-700 dark:text-gray-200"
          >
            <i class="pi pi-info-circle text-green-500 mr-1"></i>
            Description
          </label>
          <textarea
            [(ngModel)]="newGenreDescription"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Describe what makes this genre unique..."
            rows="2"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 resize-none"
            maxlength="200"
          ></textarea>
          <small class="text-gray-500 text-xs"
            >{{ newGenreDescription.length }}/200 characters</small
          >
        </div>

        <!-- Parent Genre -->
        <div class="space-y-2" *ngIf="hierarchical">
          <label
            class="block text-sm font-semibold text-gray-700 dark:text-gray-200"
          >
            <i class="pi pi-sitemap text-purple-500 mr-1"></i>
            Parent Genre
          </label>
          <p-select
            [options]="getParentGenreOptions()"
            [(ngModel)]="newGenreParentId"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Select parent genre (creates sub-genre)"
            class="w-full"
          ></p-select>
          <small class="text-gray-500 text-xs">
            <i class="pi pi-info-circle mr-1"></i>
            Leave empty to create a root genre, or select a parent to create a
            sub-genre
          </small>
        </div>

        <!-- Required Preference Level -->
        <div class="space-y-2">
          <label
            class="block text-sm font-semibold text-gray-700 dark:text-gray-200"
          >
            <i class="pi pi-star text-yellow-500 mr-1"></i>
            Your Preference Level *
          </label>
          <p-select
            [(ngModel)]="preferenceLevel"
            [options]="preferenceLevelOptions"
            [ngModelOptions]="{ standalone: true }"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
          </p-select>
          <small class="text-gray-500 text-xs">
            <i class="pi pi-info-circle mr-1"></i>
            Rate how much you like this genre (1=Dislike, 5=Love) - Required
          </small>
        </div>

        <!-- Active Status -->
        <div class="flex items-center space-x-3">
          <label class="flex items-center cursor-pointer">
            <p-checkbox
              [(ngModel)]="isGenreActive"
              [ngModelOptions]="{ standalone: true }"
              binary="true"
              inputId="genreActive"
            ></p-checkbox>
            <span
              class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-200"
            >
              <i class="pi pi-check-circle text-green-500 mr-1"></i>
              Active Genre
            </span>
          </label>
          <small class="text-gray-500 text-xs">
            Inactive genres won't appear in selection lists
          </small>
        </div>

        <!-- Exclusion Option -->
        <div class="flex items-center space-x-3">
          <label class="flex items-center cursor-pointer">
            <p-checkbox
              [(ngModel)]="isExcluded"
              [ngModelOptions]="{ standalone: true }"
              binary="true"
              inputId="genreExcluded"
            ></p-checkbox>
            <span
              class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-200"
            >
              <i class="pi pi-ban text-red-500 mr-1"></i>
              Exclude from recommendations
            </span>
          </label>
          <small class="text-gray-500 text-xs">
            Hide this genre in book suggestions
          </small>
        </div>

        <!-- Personal Notes -->
        <div class="space-y-2">
          <label
            class="block text-sm font-semibold text-gray-700 dark:text-gray-200"
          >
            <i class="pi pi-file-edit text-blue-500 mr-1"></i>
            Personal Notes
          </label>
          <textarea
            [(ngModel)]="preferenceNotes"
            [ngModelOptions]="{ standalone: true }"
            placeholder="Add personal notes about this genre preference..."
            rows="2"
            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 resize-none"
            maxlength="150"
          ></textarea>
          <small class="text-gray-500 text-xs"
            >{{ preferenceNotes.length }}/150 characters</small
          >
        </div>

        <!-- Action Buttons -->
        <div
          class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-600"
        >
          <small class="text-gray-500 text-xs">
            <i class="pi pi-info-circle mr-1"></i>
            * Required fields
          </small>
          <div class="flex gap-3">
            <button
              type="button"
              pButton
              class="p-button-outlined p-button-secondary"
              (click)="cancelAddGenre()"
              label="Cancel"
              icon="pi pi-times"
            ></button>
            <button
              type="button"
              pButton
              class="p-button-success p-button-raised"
              (click)="createNewGenre()"
              [disabled]="!canCreateGenre()"
              label="Create Genre"
              icon="pi pi-plus"
            ></button>
          </div>
        </div>
      </div>
      <small
        class="text-red-500"
        *ngIf="newGenreName && genreExists(newGenreName)"
      >
        Genre "{{ newGenreName }}" already exists
      </small>
    </div>
  </div>
</div>

<!-- Genre Preference Dialog -->
<p-dialog
  header="Set Genre Preference"
  [(visible)]="showPreferenceDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '400px', maxWidth: '90vw' }"
  *ngIf="selectedGenreForPreference"
>
  <div class="space-y-4">
    <div class="text-center">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">
        {{ selectedGenreForPreference.name }}
      </h3>
      <p
        class="text-sm text-gray-600 dark:text-gray-400"
        *ngIf="selectedGenreForPreference.description"
      >
        {{ selectedGenreForPreference.description }}
      </p>
    </div>

    <!-- Preference Level -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">
        Preference Level (1-5)
      </label>
      <p-rating
        [(ngModel)]="preferenceLevel"
        [ngModelOptions]="{ standalone: true }"
        [stars]="5"
      ></p-rating>
      <div
        class="flex justify-between text-xs text-gray-500 dark:text-gray-400"
      >
        <span>Strongly Dislike</span>
        <span>Love It</span>
      </div>
    </div>

    <!-- Exclude Checkbox -->
    <div class="flex items-center space-x-2">
      <p-checkbox
        [(ngModel)]="isExcluded"
        [ngModelOptions]="{ standalone: true }"
        binary="true"
        inputId="excludeGenre"
      ></p-checkbox>
      <label
        for="excludeGenre"
        class="text-sm text-gray-700 dark:text-gray-200"
      >
        Exclude this genre from recommendations
      </label>
    </div>

    <!-- Notes -->
    <div class="space-y-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">
        Personal Notes
      </label>
      <textarea
        [(ngModel)]="preferenceNotes"
        [ngModelOptions]="{ standalone: true }"
        placeholder="Why do you like/dislike this genre?"
        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
        rows="3"
        maxlength="500"
      ></textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <button
        type="button"
        pButton
        class="p-button-secondary"
        (click)="closePreferenceDialog()"
        label="Cancel"
      ></button>
      <button
        type="button"
        pButton
        class="p-button-success"
        (click)="savePreference()"
        label="Save Preference"
      ></button>
    </div>
  </ng-template>
</p-dialog>
